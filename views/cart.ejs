<%- include('./partials/header') %>

<% if (success && success.length> 0) { %>
        <div
            class="fixed top-20 right-6 z-50 bg-green-100 border border-green-400 text-green-700 px-6 py-4 rounded-lg shadow-lg animate-slide-in">
            <div class="flex items-center gap-3">
                <i class="ri-checkbox-circle-line text-xl"></i>
                <span class="font-medium">
                    <%= success %>
                </span>
            </div>
        </div>
        <% } %>

            <!-- ERROR FLASH -->
            <% if (error && error.length> 0) { %>
                <div
                    class="fixed top-20 right-6 z-50 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-lg animate-slide-in">
                    <div class="flex items-center gap-3">
                        <i class="ri-error-warning-line text-xl"></i>
                        <span class="font-medium">
                            <%= error %>
                        </span>
                    </div>
                </div>
                <% } %>

<div class="w-full min-h-screen bg-gray-100 py-16 px-4 md:px-16">
  <div class="w-full max-w-7xl mx-auto">

    <h1 class="text-4xl font-bold text-gray-800 mb-10">Your Cart</h1>

    <% 
      const validItems = cart ? cart.items.filter(item => item.productId) : [];
    %>

    <% if (!validItems || validItems.length === 0) { %>
      <div class="text-center bg-white p-12 rounded-xl shadow-lg">
        <h2 class="text-3xl font-bold text-gray-700 mb-4">
          Your Cart is Empty ðŸ˜”
        </h2>
        <p class="text-gray-500 mb-8">
          Looks like you haven't added anything yet.
        </p>
        <a href="/shop"
           class="inline-flex items-center bg-indigo-600 text-white px-8 py-3 rounded-xl font-semibold hover:bg-indigo-700 transition">
          <i class="ri-shopping-bag-line mr-2"></i> Start Shopping
        </a>
      </div>
    <% } else { %>

      <div class="flex flex-col lg:flex-row gap-10">

        <!-- CART ITEMS -->
        <div class="w-full lg:w-[60%] flex flex-col gap-6">

          <% validItems.forEach(item => { 
              const mrp = item.productId.price;
              const discount = item.productId.discount || 0;
              const discountedPrice = mrp - (mrp * discount) / 100;
              const subtotal = discountedPrice * item.quantity;
          %>

          <div class="bg-white rounded-2xl shadow-lg overflow-hidden">

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6">

              <!-- IMAGE -->
              <div class="flex items-center justify-center rounded-xl p-4"
                   style="background-color:<%= item.productId.bgcolor || '#f3f4f6' %>">
                <% if (item.productId.image) { %>
                  <img class="max-h-48 object-contain"
                       src="data:image/jpeg;base64,<%= item.productId.image.toString('base64') %>"
                       alt="<%= item.productId.name %>">
                <% } else { %>
                  <span class="text-gray-400">No Image</span>
                <% } %>
              </div>

              <!-- DETAILS -->
              <div class="md:col-span-2 flex flex-col justify-between">
                <div>
                  <h3 class="text-2xl font-bold text-gray-800">
                    <%= item.productId.name %>
                  </h3>

                  <p class="mt-1 text-lg font-semibold text-gray-700">
                    â‚¹ <%= discountedPrice.toFixed(0) %>
                    <% if (discount > 0) { %>
                      <span class="text-sm text-gray-400 line-through ml-2">
                        â‚¹ <%= mrp %>
                      </span>
                      <span class="text-sm text-green-600 ml-2">
                        <%= discount %>% OFF
                      </span>
                    <% } %>
                  </p>
                </div>

                <div class="flex items-center justify-between mt-6">
                  <!-- QUANTITY -->
                  <div class="flex items-center border rounded-full bg-gray-50">
                    <a href="/cart/decrease/<%= item.productId._id %>"
                       class="px-3 py-1 hover:text-indigo-600">
                      <i class="ri-subtract-line"></i>
                    </a>

                    <span class="px-4 font-bold text-lg">
                      <%= item.quantity %>
                    </span>

                    <a href="/cart/increase/<%= item.productId._id %>"
                       class="px-3 py-1 hover:text-indigo-600">
                      <i class="ri-add-line"></i>
                    </a>
                  </div>

                  <!-- REMOVE -->
                  <a href="/cart/remove/<%= item.productId._id %>"
                     class="text-red-500 hover:text-red-700 flex items-center">
                    <i class="ri-delete-bin-line mr-1"></i> Remove
                  </a>
                </div>
              </div>
            </div>

            <!-- SUBTOTAL -->
            <div class="flex justify-between items-center px-6 py-4 bg-gray-50 border-t">
              <span class="text-gray-600">
                Subtotal (<%= item.quantity %> item<%= item.quantity > 1 ? 's' : '' %>)
              </span>
              <span class="text-xl font-bold text-gray-900">
                â‚¹ <%= subtotal.toFixed(0) %>
              </span>
            </div>

          </div>

          <% }) %>
        </div>

        <!-- ORDER SUMMARY -->
        <div class="w-full lg:w-[40%]">
          <div class="bg-white rounded-2xl shadow-xl p-8 sticky top-6">

            <h3 class="text-2xl font-bold mb-6 border-b pb-4">
              Order Summary
            </h3>

            <%
              let totalMRP = 0;
              let totalDiscountAmount = 0;

              validItems.forEach(item => {
                const mrp = item.productId.price;
                const discount = item.productId.discount || 0;
                const qty = item.quantity;

                totalMRP += mrp * qty;
                totalDiscountAmount += (mrp * discount / 100) * qty;
              });

              const platformFee = 0;
              const totalAmount = Math.max(totalMRP - totalDiscountAmount + platformFee, 0);
            %>

            <div class="space-y-3 text-gray-600">
              <div class="flex justify-between">
                <span>Total MRP</span>
                <span>â‚¹ <%= totalMRP.toFixed(0) %></span>
              </div>

              <div class="flex justify-between text-green-600">
                <span>Discount</span>
                <span>- â‚¹ <%= totalDiscountAmount.toFixed(0) %></span>
              </div>

              <div class="flex justify-between">
                <span>Platform Fee</span>
                <span class="text-green-600 font-semibold">FREE</span>
                <!-- <span>â‚¹ <%= platformFee %></span> -->
              </div>

              <div class="flex justify-between">
                <span>Shipping</span>
                <span class="text-green-600 font-semibold">FREE</span>
              </div>
            </div>

            <hr class="my-6">

            <div class="flex justify-between items-center">
              <h4 class="text-xl font-bold">Total Payable</h4>
              <h4 class="text-3xl font-bold text-indigo-600">
                â‚¹ <%= totalAmount.toFixed(0) %>
              </h4>
            </div>

            <a href="/checkout"
               class="block mt-8 bg-indigo-600 text-white text-center py-4 rounded-xl font-semibold hover:bg-indigo-700">
              <i class="ri-wallet-3-line mr-2"></i> Secure Checkout
            </a>

            <p class="text-xs text-gray-400 text-center mt-4">
              Safe & Secure Payments
            </p>

          </div>
        </div>

      </div>
    <% } %>
  </div>
</div>

<%- include('./partials/footer') %>
